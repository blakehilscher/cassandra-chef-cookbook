keyspaces=(<%= node.cassandra.backup.keyspaces.join(" ") %>)

S3_BUCKET_URL="s3://<%= node.cassandra.backup.bucket_name %>"
DATE=$(date +"%Y-%m-%d")
NODE_NAME="<%= node.name %>"
CASS_DIR="<%= node.cassandra.data_root_dir %>"
DATA_DIR="$CASS_DIR/data/"


# for each configured keyspace
for keyspace in ${keyspaces[@]}; do
  # clear existing snapshot
  echo "BACKUP: nodetool clearsnapshot $keyspace"
  nodetool clearsnapshot $keyspace
  # create snapshots
  echo "BACKUP: nodetool snapshot $keyspace"
  nodetool snapshot $keyspace
  # for each table
  find "$DATA_DIR/${keyspace}" -maxdepth 1 -type d | while read -r dir; do
    # if snapshots are present
    if [ -d "${dir}/snapshots" ]; then
      # send the snapshots to s3
      echo "BACKUP: aws s3 sync ${dir}/snapshots $S3_BUCKET_URL/$DATE/$NODE_NAME/${keyspace}/$TABLE_NAME/snapshots"
      TABLE_NAME=$(basename ${dir})
      aws s3 sync "${dir}/snapshots" "$S3_BUCKET_URL/$DATE/$NODE_NAME/${keyspace}/$TABLE_NAME/snapshots"
    fi
  done
done